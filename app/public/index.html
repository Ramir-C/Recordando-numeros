<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Memoria de Figuras</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #3498db;
        }
        #container { width: 80%; margin: 0 auto; }
        #gameSection { display: none; }
        #gameArea {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .figure {
            width: 80px;
            height: 80px;
            margin: 15px;
            cursor: pointer;
            border: 3px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        #startButton, #nextButton, #restartButton {
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 16px;
        }
        #gameResult { display: none; }
        #challengeText { font-size: 18px; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>
    <div id="container">
        <div id="startSection">
            <h1>Recordando números</h1>
            <img src="/Imagen2.png" alt="Welcome Back Image">
            <p>¡Bienvenido!</p>
            <p>Memoriza los números de las figuras y luego resuelve los desafíos.</p>
            <input type="text" id="playerName" placeholder="Ingresa tu nombre">
            <button id="startButton" onclick="startGame()">Comenzar Juego</button>
            <div id="resultMessage"></div>
        </div>

        <div id="gameSection">
            <p>¡Observa, recuerda y gana!</p>
            <div id="challengeText"></div>
            <div id="gameArea"></div>
            <button id="nextButton" style="display:none;" onclick="nextChallenge()">Siguiente Desafío</button>
            <button id="restartButton" style="display:none;" onclick="restartGame()">Jugar de Nuevo</button>
            <div id="gameResult"></div>
            <div id="attemptCount"></div>
        </div>
    </div>

    <audio id="successSound" src="/acierto.wav"></audio>
    <audio id="errorSound" src="/error.wav"></audio>

    <script>
        const figures = [];
        const challenges = [
            'Toca la figura que tiene número par.',
            'Toca la figura que tiene número impar.',
            'Toca la figura con el número de menor valor.',
            'Toca la figura con el número mayor valor.',
            'Toca una de las figuras que tiene un número que se repita.',
            'Toca la figura que tenga un número con valor menor a 10.',
            'Toca la figura que tenga un número con valor mayor a 10.',
            'Toca la figura que si sumas dos veces su valor es mayor a 30.',
            'Toca la figura que si sumas dos veces su valor es menor a 30.'
        ];

        let currentChallengeIndex = 0;
        let totalErrors = 0;
        let startTime;
        let endTime;
        let playerName;
        let attemptCount = 0;

        function startGame() {
            playerName = document.getElementById('playerName').value.trim();
            if (!playerName) { alert("Por favor, ingresa tu nombre."); return; }
            attemptCount++;
            document.getElementById('startSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            document.getElementById('restartButton').style.display = 'none';
            document.getElementById('gameArea').innerHTML = '';
            document.getElementById('gameResult').innerHTML = '';
            totalErrors = 0;
            currentChallengeIndex = 0;
            figures.length = 0;
            startTime = new Date();
            showFigures();
            setTimeout(hideNumbers, 5000);
            document.getElementById('attemptCount').textContent = `Intento: ${attemptCount}`;
        }

        function showFigures() {
            const gameArea = document.getElementById('gameArea');
            for (let i = 1; i <= 10; i++) {
                const number = Math.floor(Math.random() * 20) + 1;
                const figure = createFigure(number);
                figures.push({ number, figure });
                gameArea.appendChild(figure);
            }
        }

        function createFigure(number) {
            const figure = document.createElement('div');
            figure.className = 'figure';
            figure.textContent = number;
            figure.addEventListener('click', () => handleFigureClick(number));
            return figure;
        }

        function hideNumbers() {
            figures.forEach(item => {
                item.figure.textContent = '';
                item.figure.style.backgroundColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
            });
            showChallenge();
        }

        function showChallenge() {
            document.getElementById('challengeText').textContent = challenges[currentChallengeIndex];
            setTimeout(() => { document.getElementById('challengeText').textContent = ''; }, 8000);
        }

        function handleFigureClick(number) {
            const challenge = challenges[currentChallengeIndex];
            let message = 'Incorrecto. Intenta de nuevo.';
            switch (currentChallengeIndex) {
                case 0: message = isEven(number) ? '¡Correcto!' : message; break;
                case 1: message = isOdd(number) ? '¡Correcto!' : message; break;
                case 2: message = (Math.min(...figures.map(f => f.number)) === number) ? '¡Correcto!' : message; break;
                case 3: message = (Math.max(...figures.map(f => f.number)) === number) ? '¡Correcto!' : message; break;
                case 4:
                    const repeating = figures.map(f => f.number).filter((n,i,a)=>a.indexOf(n)!==i);
                    message = repeating.includes(number) ? '¡Correcto!' : message;
                    break;
                case 5: message = number < 10 ? '¡Correcto!' : message; break;
                case 6: message = number > 10 ? '¡Correcto!' : message; break;
                case 7:
                    const sum30 = figures.some((a,i)=>figures.some((b,j)=>i!==j && (a.number + b.number === 30)));
                    message = sum30 ? '¡Correcto!' : message; break;
                case 8:
                    const sumDouble = figures.some((a,i)=>figures.some((b,j)=>i!==j && (a.number + b.number*2 < 30)));
                    message = sumDouble ? '¡Correcto!' : message; break;
            }

            document.getElementById('gameResult').textContent = message;
            if (message.includes('Incorrecto')) {
                totalErrors++;
                document.getElementById('errorSound').play();
                if (totalErrors >= 5) endGame('¡Has cometido demasiados errores! ¡Inténtalo de nuevo!');
            } else {
                document.getElementById('successSound').play();
                if (currentChallengeIndex < challenges.length - 1) nextChallenge();
                else endGame('¡Felicidades! Has completado todos los desafíos.');
            }
        }

        function isEven(n){ return n % 2 === 0; }
        function isOdd(n){ return n % 2 !== 0; }
        function nextChallenge(){ currentChallengeIndex++; showChallenge(); }

        function endGame(message) {
            endTime = new Date();
            const timeTaken = (endTime - startTime)/1000;
            const minutes = Math.floor(timeTaken/60);
            const seconds = Math.round(timeTaken%60);
            const resultMessage = `${message}<br>Total de errores: ${totalErrors}.<br>Tu tiempo: ${minutes} min ${seconds} seg.<br>Intento: ${attemptCount}`;
            document.getElementById('resultMessage').innerHTML = resultMessage;
            document.getElementById('restartButton').style.display = 'inline-block';
            document.getElementById('startSection').style.display = 'block';
            document.getElementById('gameSection').style.display = 'none';
            submitGameData(timeTaken, totalErrors, attemptCount);
        }

        function restartGame(){ startGame(); }

        function submitGameData(timeTaken, errors, intentos) {
            fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: playerName,
                    tiempo: timeTaken,
                    errores: errors,
                    intento: intentos
                })
            })
            .then(res => res.json())
            .then(data => console.log('Datos guardados:', data))
            .catch(err => console.error('Error al guardar:', err));
        }
    </script>
</body>
</html>
